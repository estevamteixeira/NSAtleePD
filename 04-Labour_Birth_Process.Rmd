---
params:
  year1: 2010
  year2: 2019
fig.caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.pos = "h", 
  out.extra = "",
  out.width = '90%',
  fig.align = 'center',
  eval.after = "fig.cap")

pckgs <- c('tidyverse', 'knitr', 'scales','janitor',
           'kableExtra', 'formattable','data.table',
           'forcats','lubridate', 'anytime','reactable',
           'htmltools', 'plotly','purrr')
# for (pp in `pckgs`)00/870 { if (!require(pp)) install.packages(pp); library(pp, character.only = T)  }

if (!require("pacman")) install.packages("pacman")
pacman::p_load(pckgs, character.only = TRUE)
## data input

# add data
dta <- readr::read_csv("data/NSAtleePD.csv") %>%
  setDT() %>%
  .[data.table::between(BrthYear, params$year1, params$year2), ]
```

<!-- # (PART) Deliveries and Births {-} -->

# Labour and Birth Processes {#section-4}

##  Labour induction by parity and year, Nova Scotia, `r paste0(params$year1,"-",params$year2)` {#section-41}

```{r plot41, fig.cap= paste('Labour induction by parity and year, Nova Scotia,', paste0(params$year1,"-",params$year2))}

dta1 <- dta[, .(BrthYear,
               LABOUR,
               FAILED_INDUCTION,
               DLPARA)] %>%
  .[!is.na(DLPARA) |
    !is.na(LABOUR) |
    !is.na(FAILED_INDUCTION)] %>%
  .[, `:=` (ind = fcase(
    tolower(LABOUR) %in% "i" | tolower(FAILED_INDUCTION) %in% "y", 1,
    default = 0
    ),
    parity = fcase(
    DLPARA %in% 0 , 1,
    DLPARA %in% 1, 2,
    default = 3
    ))] %>%
  .[order(BrthYear, parity, ind)] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, parity, ind)] %>%
  .[, `:=` (total = .N), by = list(BrthYear, parity)] %>%
  .[, `:=` (rate = count/total)] %>%
  unique()

# age category using UNICODE codes
dta1 <- dta1[, `:=` (ind = factor(ind,
                                   levels = c(0,1),
                                   labels = c("No",
                                              "Induction attempted")),
                     parity = factor(parity,
                                   levels = c(1,2,3),
                                   labels = c("0",
                                              "1",
                                              "\u2265 2")))]

## getting color for plotting

pal <- c("0" = "#1b9e77",
         "1" = "#d95f02",
         "\u2265 2" = "#7570b3")

plot <- ggplot(data = dta1[!ind %in% c("No")],
               aes(x = BrthYear,
                   y = rate,
                   group = parity,
                   colour = parity,
                   fill = parity,
                   shape = parity,
                   text =paste(parity,
                               "<br>Year:", BrthYear,
                               "<br># births:", scales::comma(total, accuracy = 1),
                               "<br>% of deliveries:" , scales::percent(rate, accuracy = .1)
                               )
                   )
               ) +
  geom_point(aes(color = parity, fill = parity, shape = parity)) +
  geom_line(aes(color = parity, fill = parity)) +
# Specifying colors by age group
  scale_color_manual(name = "",
                     values = pal,
                     limits = names(pal)) +
  scale_fill_manual(name = "",
                    values = pal,
                    limits = names(pal)) +
  scale_shape_manual(name = "",
                     values = c(15, 16, 17)) +
  # scale_x_date(date_breaks = "2 years",
  #              date_labels = "%Y") +
  scale_x_continuous(#trans = 'log2',
    breaks = pretty) +
  scale_y_continuous(#trans = 'log2',
    breaks = pretty,
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, NA)) +
  labs(y = '% of deliveries', x = '') +
  theme_minimal()

plotly::ggplotly(plot, tooltip = c("text")) %>%
  plotly::style(hoverlabel = list(
    bgcolor  = "black",
    bordercolor = "transparent",
    font = list(
      color = "white",
      size = 14,
      face = "bold"
    )
  )) %>%
  plotly::layout(legend = list(orientation = "h", y = -0.25, x = 0.5,
                               xanchor = "center"),
                 font = list(face = "bold", size = 10),
                 showlegend = TRUE)
```

```{r tbl41}
tbl <- dta[, .(BrthYear,
               LABOUR,
               FAILED_INDUCTION,
               DLPARA)] %>%
  .[!is.na(DLPARA) |
    !is.na(LABOUR) |
    !is.na(FAILED_INDUCTION)] %>%
  .[, `:=` (ind = fcase(
    tolower(LABOUR) %in% "i" | tolower(FAILED_INDUCTION) %in% "y", 1,
    default = 0
    ),
    parity = fcase(
    DLPARA %in% 0 , 1,
    DLPARA %in% 1, 2,
    default = 3
    ))] %>%
  .[order(BrthYear, parity, ind)] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, parity, ind)] %>%
  .[, `:=` (total = .N), by = list(BrthYear, parity)] %>%
  .[, `:=` (rate = 100*count/total)] 

tbl1 <- tbl %>%
  .[parity %in% 1 & ind %in% 1] %>%
 melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count"] %>%
  .[, `:=` (ind = fifelse(tolower(variable) %in% "total",
                               0, ind))] %>%
  .[, .(BrthYear, ind, value)] %>%
  unique() %>%
  dcast(ind ~ BrthYear, value.var = "value")

coln <- names(tbl1)
coln[1] <- ""

tbl1 <- as.data.frame(sapply(tbl1, sprintf, fmt = c("%.0f", "%1.1f%%")))
names(tbl1) <- coln

tbl1[,1] <- c("# deliveries", "% induction attempted")

tbl2 <- tbl %>%
  .[parity %in% 2 & ind %in% 1] %>%
 melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count"] %>%
  .[, `:=` (ind = fifelse(tolower(variable) %in% "total",
                               0, ind))] %>%
  .[, .(BrthYear, ind, value)] %>%
  unique() %>%
  dcast(ind ~ BrthYear, value.var = "value")

coln <- names(tbl2)
coln[1] <- ""

tbl2 <- as.data.frame(sapply(tbl2, sprintf, fmt = c("%.0f", "%1.1f%%")))
names(tbl2) <- coln

tbl2[,1] <- c("# deliveries", "% induction attempted")

tbl3 <- tbl %>%
  .[parity %in% 3 & ind %in% 1] %>%
 melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count"] %>%
  .[, `:=` (ind = fifelse(tolower(variable) %in% "total",
                               0, ind))] %>%
  .[, .(BrthYear, ind, value)] %>%
  unique() %>%
  dcast(ind ~ BrthYear, value.var = "value")

coln <- names(tbl3)
coln[1] <- ""

tbl3 <- as.data.frame(sapply(tbl3, sprintf, fmt = c("%.0f", "%1.1f%%")))
names(tbl3) <- coln

tbl3[,1] <- c("# deliveries", "% induction attempted")

tbl <- setDT(rbind(tbl1, tbl2, tbl3))
names(tbl)[1] <- "Parity" 

knitr::kable(tbl,
             format = "html",
             booktabs = TRUE) %>%
  # add an hline before the total
#kableExtra::row_spec(nrow(tbl) - 1, hline_after = TRUE) %>%  #kableExtra::row_spec(nrow(tbl), bold = TRUE) %>%
kableExtra::row_spec(0, bold = TRUE) %>%
#kableExtra::column_spec(1, border_right = TRUE, bold  = TRUE) %>%
kableExtra::group_rows("0", start_row = 1, end_row = 2) %>%
kableExtra::group_rows("1", start_row = 3, end_row = 4) %>%
kableExtra::group_rows("\u2265 2", start_row = 5, end_row = 6) %>%
kableExtra::kable_styling(font_size = 12, full_width = FALSE,
                          bootstrap_options = c("hover","condensed", "responsive")) %>%
kableExtra::add_footnote(label = c("Note: The initiation of contractions in a pregnant woman who is not in labour to help her achieve a vaginal birth within 24 to 48 hours."))
```

## Indication for labour induction by year, Nova Scotia, `r paste0(params$year1,"-",params$year2)` {#section-42}

```{r plot42, fig.cap= paste('Indication for labour induction by year, Nova Scotia,', paste0(params$year1,"-",params$year2))}

dta1 <- dta[, .(BrthYear,
                LABOUR,
                FAILED_INDUCTION,
                DMINDUCT,
                DLPARA)] %>%
  .[#!is.na(DLPARA) |
    !is.na(LABOUR) |
    !is.na(FAILED_INDUCTION)] %>%
  .[, `:=` (ind = fcase(
    tolower(LABOUR) %in% "i" | tolower(FAILED_INDUCTION) %in% "y", 1,
    default = 0
    ),
    ind_reason = fcase(
    DMINDUCT %in% 4, 1,
    DMINDUCT %in% 12, 2,
    DMINDUCT %in% 5, 3,
    DMINDUCT %in% c(2, 3, 6, 7, 9, 14, 16, 17, 18, 19, 20, 22, 27, 28), 4,
    default = 5
    ))] %>%
  .[order(BrthYear, ind_reason)] %>%
  .[ind %in% 1] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, ind_reason)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = count/total)] %>%
  unique()

# age category using UNICODE codes
dta1 <- dta1[, `:=` (ind_reason = factor(ind_reason,
                                   levels = c(1,2,3,4,5),
                                   labels = c("Post dates",
                                              "Hypertensive disease",
                                              "PRoM without chorioamnionitis",
                                              "Other medical reason",
                                              "Other or unspecified")))]

## getting color for plotting

pal <- c("Post dates" = "#1b9e77",
         "Hypertensive disease" = "#d95f02",
         "PRoM without chorioamnionitis" = "#7570b3",
         "Other medical reason" = "#e7298a",
         "Other or unspecified" = "#e6ab02")

plot <- ggplot(data = dta1,
               aes(x = BrthYear,
                   y = rate,
                   group = ind_reason,
                   colour = ind_reason,
                   fill = ind_reason,
                   shape = ind_reason,
                   text =paste(ind_reason,
                               "<br>Year:", BrthYear,
                               "<br># births:", scales::comma(total, accuracy = 1),
                               "<br>% of deliveries:" , scales::percent(rate, accuracy = .1)
                               )
                   )
               ) +
  geom_point(aes(color = ind_reason, fill = ind_reason, shape = ind_reason)) +
  geom_line(aes(color = ind_reason, fill = ind_reason)) +
# Specifying colors by age group
  scale_color_manual(name = "",
                     values = pal,
                     limits = names(pal)) +
  scale_fill_manual(name = "",
                    values = pal,
                    limits = names(pal)) +
  scale_shape_manual(name = "",
                     values = c(15,16,17,18,19)) +
  # scale_x_date(date_breaks = "2 years",
  #              date_labels = "%Y") +
  scale_x_continuous(#trans = 'log2',
    breaks = pretty) +
  scale_y_continuous(#trans = 'log2',
    breaks = pretty,
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, NA)) +
  labs(y = '% of deliveries', x = '') +
  theme_minimal()

plotly::ggplotly(plot, tooltip = c("text")) %>%
  plotly::style(hoverlabel = list(
    bgcolor  = "black",
    bordercolor = "transparent",
    font = list(
      color = "white",
      size = 14,
      face = "bold"
    )
  )) %>%
  plotly::layout(legend = list(orientation = "h", y = -0.25, x = 0.5,
                               xanchor = "center"),
                 font = list(face = "bold", size = 10),
                 showlegend = TRUE)
```

```{r tbl42}
tbl <- dta[, .(BrthYear,
                LABOUR,
                FAILED_INDUCTION,
                DMINDUCT,
                DLPARA)] %>%
  .[#!is.na(DLPARA) |
    !is.na(LABOUR) |
    !is.na(FAILED_INDUCTION)] %>%
  .[, `:=` (ind = fcase(
    tolower(LABOUR) %in% "i" | tolower(FAILED_INDUCTION) %in% "y", 1,
    default = 0
    ),
    ind_reason = fcase(
    DMINDUCT %in% 4, 1,
    DMINDUCT %in% 12, 2,
    DMINDUCT %in% 5, 3,
    DMINDUCT %in% c(2, 3, 6, 7, 9, 14, 16, 17, 18, 19, 20, 22, 27, 28), 4,
    default = 5
    ))] %>%
  .[order(BrthYear, ind_reason)] %>%
  .[ind %in% 1] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, ind_reason)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = 100*count/total)] %>%
  melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count"] %>%
  .[, `:=` (ind_reason = fifelse(tolower(variable) %in% "total",
                               0, ind_reason))] %>%
  .[, .(BrthYear, ind_reason, value)] %>%
  unique() %>%
  dcast(ind_reason ~ BrthYear, value.var = "value")

coln <- names(tbl)
coln[1] <- ""

tbl <- as.data.frame(sapply(tbl, sprintf, fmt = c("%.0f", "%1.1f%%","%1.1f%%","%1.1f%%","%1.1f%%","%1.1f%%")))
names(tbl) <- coln

tbl[,1] <- c("# induction attempts", "Post dates", "Hypertensive disease", "PRoM without chorioamnionitis", "Other medical reason", "Other or unspecified")


knitr::kable(tbl,
             format = "html",
             booktabs = TRUE) %>%
  # add an hline before the total
#kableExtra::row_spec(nrow(tbl) - 1, hline_after = TRUE) %>%  #kableExtra::row_spec(nrow(tbl), bold = TRUE) %>%
kableExtra::row_spec(0, bold = TRUE) %>%
#kableExtra::column_spec(1, border_right = TRUE, bold  = TRUE) %>%
kableExtra::group_rows("0", start_row = 1, end_row = 2) %>%
kableExtra::group_rows("1", start_row = 3, end_row = 4) %>%
kableExtra::group_rows("\u2265 2", start_row = 5, end_row = 6) %>%
kableExtra::kable_styling(font_size = 12, full_width = FALSE,
                          bootstrap_options = c("hover","condensed", "responsive")) %>%
kableExtra::add_footnote(label = c("PRoM: Prelabour rupture of membranes.",
                                   "Please see Glossary under 'Indication for labour induction; for complete list."))
```

## Medical augmentation of labour among women with spontaneous onset of labour by year, Nova Scotia, `r paste0(params$year1,"-",params$year2)` {#section-43}

```{r plot43, fig.cap= paste('Medical augmentation of labour among women with spontaneous onset of labour by year, Nova Scotia,', paste0(params$year1,"-",params$year2))}

dta1 <- dta[, .(BrthYear,
                AUGMENT)] %>%
  .[!is.na(AUGMENT)] %>%
  .[, `:=` (aug = fcase(
    tolower(AUGMENT) %in% "y", 1,
    default = 0
    ))] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, aug)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = count/total)] %>%
  unique()

# age category using UNICODE codes
dta1 <- dta1[, `:=` (aug = factor(aug,
                                   levels = c(0,1),
                                   labels = c("No",
                                              "Augmented")))]

## getting color for plotting

pal <- c("No" = "#1b9e77",
         "Augmented" = "#d95f02")

plot <- ggplot(data = dta1[!aug %in% "No"],
               aes(x = BrthYear,
                   y = rate,
                   group = aug,
                   colour = aug,
                   fill = aug,
                   #shape = aug,
                   text =paste(aug,
                               "<br>Year:", BrthYear,
                               "<br># births:", scales::comma(total, accuracy = 1),
                               "<br>% of deliveries:" , scales::percent(rate, accuracy = .1)
                               )
                   )
               ) +
  geom_point(aes(color = aug, fill = aug)) +
  geom_line(aes(color = aug, fill = aug)) +
# Specifying colors by age group
  scale_color_manual(name = "",
                     values = pal,
                     limits = names(pal)) +
  scale_fill_manual(name = "",
                    values = pal,
                    limits = names(pal)) +
  # scale_shape_manual(name = "",
  #                    values = c(15,16,17,18,19)) +
  # scale_x_date(date_breaks = "2 years",
  #              date_labels = "%Y") +
  scale_x_continuous(#trans = 'log2',
    breaks = pretty) +
  scale_y_continuous(#trans = 'log2',
    breaks = pretty,
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, NA)) +
  labs(y = '% of deliveries', x = '') +
  theme_minimal()

plotly::ggplotly(plot, tooltip = c("text")) %>%
  plotly::style(hoverlabel = list(
    bgcolor  = "black",
    bordercolor = "transparent",
    font = list(
      color = "white",
      size = 14,
      face = "bold"
    )
  )) %>%
  plotly::layout(legend = list(orientation = "h", y = -0.25, x = 0.5,
                               xanchor = "center"),
                 font = list(face = "bold", size = 10),
                 showlegend = FALSE)
```

```{r tbl43}
tbl <- dta[, .(BrthYear,
                AUGMENT)] %>%
  .[!is.na(AUGMENT)] %>%
  .[, `:=` (aug = fcase(
    tolower(AUGMENT) %in% "y", 1,
    default = 0
    ))] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, aug)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = 100*count/total)] %>%
  melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count" &
      !aug %in% 0] %>%
  .[, `:=` (aug = fifelse(tolower(variable) %in% "total",
                               0, aug))] %>%
  .[, .(BrthYear, aug, value)] %>%
  unique() %>%
  dcast(aug ~ BrthYear, value.var = "value")

coln <- names(tbl)
coln[1] <- ""

tbl <- as.data.frame(sapply(tbl, sprintf, fmt = c("%.0f", "%1.1f%%")))
names(tbl) <- coln

tbl[,1] <- c("# spontaneous labour", "Augmented")


knitr::kable(tbl,
             format = "html",
             booktabs = TRUE) %>%
  # add an hline before the total
#kableExtra::row_spec(nrow(tbl) - 1, hline_after = TRUE) %>%  #kableExtra::row_spec(nrow(tbl), bold = TRUE) %>%
kableExtra::row_spec(0, bold = TRUE) %>%
#kableExtra::column_spec(1, border_right = TRUE, bold  = TRUE) %>%
kableExtra::group_rows("0", start_row = 1, end_row = 2) %>%
kableExtra::group_rows("1", start_row = 3, end_row = 4) %>%
kableExtra::group_rows("\u2265 2", start_row = 5, end_row = 6) %>%
kableExtra::kable_styling(font_size = 12, full_width = FALSE,
                          bootstrap_options = c("hover","condensed", "responsive")) %>%
kableExtra::add_footnote(label = c("Note: Use of oxytocin to improve contractions after labour has started spontaneously."))
```

## Use of regional anesthesia with vaginal delivery by year, Nova Scotia, `r paste0(params$year1,"-",params$year2)` {#section-44}

```{r plot44, fig.cap= paste('Use of regional anesthesia with vaginal delivery by year, Nova Scotia,', paste0(params$year1,"-",params$year2))}

dta1 <- dta[, .(BrthYear,
                R010_00200, R010_00300, R010_00400, R010_00500, R010_00600, R010_00800, R010_00900, R010_01000,
                R011_00200, R011_00300, R011_00400, R011_00500, R011_00600, R011_00800, R011_00900, R011_01000,
                R012_00200, R012_00300, R012_00400, R012_00500, R012_00600, R012_00800, R012_00900, R012_01000,
                MEPIS, MEPIC, MIFUS, MPCEA, MSEDN, MSPIN, MPUDL, MGENA)] %>%
  .[, epi := rowSums(.SD, na.rm = TRUE), .SDcols = c("R010_00200","R010_00300", "R010_00400","R010_00500","R010_01000","R011_00200","R011_00300","R011_00400","R011_00500","R011_01000","R012_00200","R012_00300","R012_00400","R012_00500","R012_01000","MEPIS","MEPIC","MIFUS","MPCEA","MSEDN")] %>%
  .[, spi := rowSums(.SD, na.rm = TRUE), .SDcols = c("R010_00900","R010_01000","R011_00900","R011_01000","R012_00900","R012_01000","MSPIN","MSEDN")] %>%
  .[, dou := rowSums(.SD, na.rm = TRUE), .SDcols = c("R010_01000","R011_01000","R012_01000","MSEDN")] %>%
  .[, pud := rowSums(.SD, na.rm = TRUE), .SDcols = c("R010_00800","R011_00800","R012_00800","MPUDL")] %>%
  .[, gen := rowSums(.SD, na.rm = TRUE), .SDcols = c("R010_00600","R011_00600","R012_00600","MGENA")] %>%
  .[, `:=` (anes = fcase(
    epi >= 1 | spi >= 1 | dou >= 1 | pud >= 1 | gen >= 1, 1,
    default = 0
    ))] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, anes)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = count/total)] %>%
  unique()

# age category using UNICODE codes
dta1 <- dta1[, `:=` (aug = factor(aug,
                                   levels = c(0,1),
                                   labels = c("No",
                                              "Augmented")))]

## getting color for plotting

pal <- c("No" = "#1b9e77",
         "Augmented" = "#d95f02")

plot <- ggplot(data = dta1[!aug %in% "No"],
               aes(x = BrthYear,
                   y = rate,
                   group = aug,
                   colour = aug,
                   fill = aug,
                   #shape = aug,
                   text =paste(aug,
                               "<br>Year:", BrthYear,
                               "<br># births:", scales::comma(total, accuracy = 1),
                               "<br>% of deliveries:" , scales::percent(rate, accuracy = .1)
                               )
                   )
               ) +
  geom_point(aes(color = aug, fill = aug)) +
  geom_line(aes(color = aug, fill = aug)) +
# Specifying colors by age group
  scale_color_manual(name = "",
                     values = pal,
                     limits = names(pal)) +
  scale_fill_manual(name = "",
                    values = pal,
                    limits = names(pal)) +
  # scale_shape_manual(name = "",
  #                    values = c(15,16,17,18,19)) +
  # scale_x_date(date_breaks = "2 years",
  #              date_labels = "%Y") +
  scale_x_continuous(#trans = 'log2',
    breaks = pretty) +
  scale_y_continuous(#trans = 'log2',
    breaks = pretty,
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, NA)) +
  labs(y = '% of deliveries', x = '') +
  theme_minimal()

plotly::ggplotly(plot, tooltip = c("text")) %>%
  plotly::style(hoverlabel = list(
    bgcolor  = "black",
    bordercolor = "transparent",
    font = list(
      color = "white",
      size = 14,
      face = "bold"
    )
  )) %>%
  plotly::layout(legend = list(orientation = "h", y = -0.25, x = 0.5,
                               xanchor = "center"),
                 font = list(face = "bold", size = 10),
                 showlegend = FALSE)
```

```{r tbl44}
tbl <- dta[, .(BrthYear,
                AUGMENT)] %>%
  .[!is.na(AUGMENT)] %>%
  .[, `:=` (aug = fcase(
    tolower(AUGMENT) %in% "y", 1,
    default = 0
    ))] %>%
  #unique() %>%
  .[, `:=` (count = .N), by = list(BrthYear, aug)] %>%
  .[, `:=` (total = .N), by = list(BrthYear)] %>%
  .[, `:=` (rate = 100*count/total)] %>%
  melt(measure.vars = c("rate", "total", "count")) %>%
  .[!tolower(variable) %in% "count" &
      !aug %in% 0] %>%
  .[, `:=` (aug = fifelse(tolower(variable) %in% "total",
                               0, aug))] %>%
  .[, .(BrthYear, aug, value)] %>%
  unique() %>%
  dcast(aug ~ BrthYear, value.var = "value")

coln <- names(tbl)
coln[1] <- ""

tbl <- as.data.frame(sapply(tbl, sprintf, fmt = c("%.0f", "%1.1f%%")))
names(tbl) <- coln

tbl[,1] <- c("# spontaneous labour", "Augmented")


knitr::kable(tbl,
             format = "html",
             booktabs = TRUE) %>%
  # add an hline before the total
#kableExtra::row_spec(nrow(tbl) - 1, hline_after = TRUE) %>%  #kableExtra::row_spec(nrow(tbl), bold = TRUE) %>%
kableExtra::row_spec(0, bold = TRUE) %>%
#kableExtra::column_spec(1, border_right = TRUE, bold  = TRUE) %>%
kableExtra::group_rows("0", start_row = 1, end_row = 2) %>%
kableExtra::group_rows("1", start_row = 3, end_row = 4) %>%
kableExtra::group_rows("\u2265 2", start_row = 5, end_row = 6) %>%
kableExtra::kable_styling(font_size = 12, full_width = FALSE,
                          bootstrap_options = c("hover","condensed", "responsive")) %>%
kableExtra::add_footnote(label = c("Note: Use of oxytocin to improve contractions after labour has started spontaneously."))
```